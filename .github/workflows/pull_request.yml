name: Labeling and Linting
on: [pull_request]

jobs:
  label:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/labeler@v2
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"

  analysis:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - name: Check out code.
        uses: actions/checkout@v2.3.4

      - name: ReviewDog Misspell
        uses: reviewdog/action-misspell@v1
        with:
          github_token: ${{ secrets.github_token }}
          locale: "US"
          reporter: github-pr-review

  formatting:
    name: Code Formatter
    runs-on: ubuntu-latest
    steps:
      - name: Check out code.
        uses: actions/checkout@v2.3.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare java
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Install clojure tools
        uses: DeLaGuardo/setup-clojure@3.2
        with:
          lein: 2.9.1

      - name: Cache Maven Dependencies
        uses: actions/cache@v2
        env:
            cache-name: cache-maven
        with:
            path: ~/.m2
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('**/project.clj') }}
            restore-keys: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('**/project.clj') }}

      - name: Auto-Format Clojure
        run: lein cljfmt fix

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Auto-Format Terraform
        run: terraform fmt -recursive

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: linter - Format Clojure and Terraform
